# character just about to die in root scope
# if a killer is know, it's set as scope:killer
#Triggered by code

on_death = {
	events = {
		agot_small_council.0002 # Cleans up Small Councillor
		agot_kingsguard.1000 # KG Maintenance
		agot_widowed_events.999 #Check to see if widowed story cycle should begin
		agot_valyrian_steel.0003
		agot_dragonstone.0006
		agot_dragon.0001
	}
	on_actions = {
		agot_after_death_on_action
		faegon_on_death_on_action
		faegon_taken_title_from_death_on_action
	}
}

agot_after_death_on_action = {
	trigger = {
		always = yes
	}
	effect = {
		if = {
			limit = { has_trait = dragon }
			save_scope_as = dead_dragon
			if = {
				limit = {
					agot_ruins_has_dragon_storage_system = yes
				}
				title:c_ruins.holder = {
					every_owned_story = {
						limit = {
							story_type = story_dragon_variable_storage
							var:dragon_id ?= root
						}
						save_scope_as = dragon_var_story_val
					}
				}
				every_in_list = {
					variable = past_riders
					scope:dragon_var_story_val = {
						add_to_variable_list = {
							name = past_riders
							target = prev
						}
					}
				}
			}
			every_player = {
				limit = { always = yes }
				send_interface_message = {
					type = msg_dragon_death
					title = {
						first_valid = {
							triggered_desc = {
								trigger = {
									any_living_dragon = {
										count = 0
									}
								}
								desc = agot_dragon_maintenance.0904.t_last_dragon_died
							}
							triggered_desc = {
								trigger = {
									any_living_dragon = {
										count <= 5
									}
								}
								desc = agot_dragon_maintenance.0904.t
							}
							triggered_desc = {
								trigger = {
									any_living_dragon = {
										count > 5
									}
								}
								desc = agot_dragon_maintenance.0904.t_many_dragons_extant
							}
						}
					}
					desc = agot_dragon_maintenance_msg_dragon_death_placeholder
					left_icon = scope:dead_dragon
				}
			}
			agot_dragon_death_magic_effect = yes
			agot_dead_dragon_effect = yes
		}
		else_if = {
			limit = {
				exists = var:current_dragon
			}
			random_equipped_character_artifact = {
				limit = {
					artifact_type = dragon_horn
				}
				clear_variable_list = tamed_dragons
			}
			save_scope_as = dead_rider
			var:current_dragon = {
				save_scope_as = dead_riders_dragon
			}
			scope:dead_riders_dragon = { trigger_event = { id = agot_dragon.0002 } } # Needs to fire on the dragon because of diseases causing on_death orders of operation trickery.
		}
		else_if = {
			limit = {
				is_human = yes
				any_relation = {
					type = agot_dragon
				}
			}
			save_scope_as = dead_rider
			random_relation = {
				type = agot_dragon
				save_scope_as = dead_riders_dragon
			}
			scope:dead_riders_dragon = { trigger_event = { id = agot_dragon.0002 } } # Needs to fire on the dragon because of diseases causing on_death orders of operation trickery.
		}
		save_scope_as = dead_relative
		every_close_family_member = {
			if = {
				limit = { is_ruler = yes }
				random_list = {
					100 = {}
					1 = {
						trigger_event = {
							id = agot_silent_sisters.0007 # Find Silent Sister defiling relative
							days = { 5 7 }
						}
					}
					1 = {
						trigger_event = {
							id = agot_silent_sisters.0005 # Find Silent Sister Aluring
							days = { 2 4 }
						}
					}
				}
			}
		}
	}
}

faegon_on_death_on_action = {
	trigger = {
		root = {
			any_owned_story = {
				OR = {
					story_type = agot_story_6th_blackfyre_rebellion
					story_type = agot_story_targ_faegon_landing
				}
			}
		}
	}

	effect = {
		if = {
			limit = {
				any_owned_story = {
					story_type = agot_story_6th_blackfyre_rebellion
				}
			}
			create_title_and_vassal_change = {
				type = created
				save_scope_as = change
			}

			random_owned_story = {
				limit = {
					story_type = agot_story_6th_blackfyre_rebellion
				}
				save_scope_as = faegon_fyre_story
			}

			scope:faegon_fyre_story = {
				var:agot_faegon_landing_title = {
					remove_county_modifier = agot_deserted_province
					change_title_holder = {
						holder = prev.var:agot_faegon_taken_title_from
						change = scope:change
					}
				}
			}

			resolve_title_and_vassal_change = scope:change
		}

		if = {
			limit = {
				any_owned_story = {
					story_type = agot_story_targ_faegon_landing
				}
			}
			create_title_and_vassal_change = {
				type = created
				save_scope_as = change
			}

			random_owned_story = {
				limit = {
					story_type = agot_story_targ_faegon_landing
				}
				save_scope_as = faegon_story
			}

			scope:faegon_story = {
				var:agot_faegon_landing_title = {
					remove_county_modifier = agot_deserted_province
					change_title_holder = {
						holder = prev.var:agot_faegon_taken_title_from
						change = scope:change
					}
				}
			}

			resolve_title_and_vassal_change = scope:change
		}
	}
}

faegon_taken_title_from_death_on_action = {

	trigger = {
		has_character_flag = agot_faegon_taken_title_from_flag
		any_heir = {
			count >= 1
		}
	}

	effect = {
		random_ruler = {
			limit = {
				any_owned_story = {
					OR = {
						story_type = agot_story_6th_blackfyre_rebellion
						story_type = agot_story_targ_faegon_landing
					}
				}
			}
			if = {
				limit = {
					any_owned_story = {
						story_type = agot_story_6th_blackfyre_rebellion
					}
				}
				random_owned_story = {
					limit = {
						story_type = agot_story_6th_blackfyre_rebellion
					}
					remove_variable = agot_faegon_taken_title_from
					set_variable = {
						name = agot_faegon_taken_title_from
						value = root.primary_heir
					}
					root.primary_heir = {
						add_character_flag = agot_faegon_taken_title_from_flag
					}
				}
			}
			else_if = {
				limit = {
					any_owned_story = {
						story_type = agot_story_targ_faegon_landing
					}
				}
				random_owned_story = {
					limit = {
						story_type = agot_story_targ_faegon_landing
					}
					remove_variable = agot_faegon_taken_title_from
					set_variable = {
						name = agot_faegon_taken_title_from
						value = root.primary_heir
					}
					root.primary_heir = {
						add_character_flag = agot_faegon_taken_title_from_flag
					}
				}
			}
		}
	}
}