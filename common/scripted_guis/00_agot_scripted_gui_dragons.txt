agot_can_have_dragon = {
	scope = character

	is_shown = {
		OR = {
			any_relation = {
				type = agot_dragon
			}
		}
	}
}


small_size_dragon = {
	scope = character

	is_shown = {
		has_trait = dragon
		dragon_size <= 18
		NOT = {
			dragon_size > 18
		}
	}
}

normal_size_dragon = {
	scope = character

	is_shown = {
		has_trait = dragon
		dragon_size > 18
		NOT = {
			dragon_size <= 18
		}
	}
}

not_dragon_or_dragonrider = {
	scope = character

	is_shown = {
		NOT = {
			OR = {
				has_trait = dragon
				has_character_flag = currently_riding_dragon
				has_character_flag = in_dragon_combat
			}
		}
	}
}

dragonrider_flight = {
	scope = character

	is_shown = {
		has_character_flag = currently_riding_dragon
	}
}

dragon_land = {
	scope = character

	is_shown = {
		has_character_flag = in_dragon_combat
	}
}

dragon = {
	#scope = empty
	saved_scopes = {
		char
	}
	is_shown = {
		exists = scope:char
		scope:char = { has_trait = dragon }
	}
}

main_dragon = {
	is_shown = {
		has_trait = dragon
	}
}

siege_dragon = {
	scope = character
	saved_scopes = { player }

	is_shown = {
		is_current_dragonrider_warfare = yes
		OR = {
			is_courtier_of = scope:player
			is_vassal_of = scope:player
			root = scope:player
		}
		trigger_if = {
			limit = {
				NOT = { root = scope:player }
			}
			is_ai = yes
		}
		location = root.location
	}

	is_valid = {
		trigger_if = {
			limit = { root = scope:player }
			custom_tooltip = {
				text = agot_dragon_siege.gui_tt_check
				NOT = { has_character_flag = used_dragon_sieged_today }
			}
		}
		trigger_else = {
			custom_tooltip = {
				text = agot_dragon_siege.gui_tt_commander_check
				NOR = { has_character_flag = recently_draconically_sieged }
			}
		}
		NOR = {
			has_trait = wounded_2
			has_trait = wounded_3
			has_trait = incapable
			has_trait = infirm
		}
		var:current_dragon = {
			AND = {
				NOT = { has_trait = dragon_wounded_2 }
				NOT = { has_trait = dragon_wounded_3 }
				NOT = { has_trait = dragon_wounded_4 }
				NOT = { has_trait = dragon_wounded_5 }
			}
		}
		location = {
			custom_tooltip = { # Can't damage more
				text = agot_dragon_siege.gui_tt_cant_damage
				NOR = {
					# Is not already ruin
					has_variable = dragon_siege_modifier_massive
					# Cannot be damaged by you anymore as the dragon is not big enough
					AND = {
						has_variable = dragon_siege_modifier_major
						root.var:current_dragon.dragon_combat_effectiveness < level_eight_dragon_combat
					}
					AND = {
						has_variable = dragon_siege_modifier_medium
						root.var:current_dragon.dragon_combat_effectiveness < level_five_dragon_combat
					}
					AND = {
						fort_level = 1
						root.var:current_dragon.dragon_combat_effectiveness < level_eight_dragon_combat
					}
				}
			}
			NOT = { # Can't dragon siege pirate dens
				has_holding_type = pirate_den_holding
			}
		}
	}

	effect = {
		save_scope_as = commander
		root.var:current_dragon = {
			save_scope_as = sieging_dragon
		}

		trigger_event = { id = agot_dragon_siege.0001 }

		custom_tooltip = agot_dragon_siege.gui_tt
		if = {
			limit = {
				location = {
					has_stationed_scorpions = yes
				}
			}
			custom_tooltip = agot_dragon_siege.gui_anti_dragon_tt
		}
		else_if = {
			limit = {
				location = {
					OR = {
						has_building = workshops_05
						has_building = workshops_06
						AND = {
							fort_level >= 10
							county.culture = { has_innovation = innovation_agot_anti_dragon_fighting }
						}
					}
				}
			}
			custom_tooltip = agot_dragon_siege.gui_scorpion_1_tt
		}
		else_if = {
			limit = {
				location = {
					OR = {
						has_building = workshops_07
						has_building = workshops_08
						AND = {
							fort_level >= 20
							county.culture = { has_innovation = innovation_agot_anti_dragon_fighting }
						}
					}
				}
			}
			custom_tooltip = agot_dragon_siege.gui_scorpion_2_tt
		}

		if = {
			limit = { NOT = { root = scope:player } }
			add_character_flag = {
				flag = recently_draconically_sieged
				months = 3
			}
		}
	}
}

capture_wild_dragon = {
	scope = character

	is_shown = {
		scope:owner ?= {
			agot_has_an_active_dragonpit = yes
		}
		has_trait = dragon
		is_alive = yes
		OR = {
			any_liege_or_above = { this = scope:owner }
			location.county = {
				holder = {
					OR = {
						any_liege_or_above = { this = scope:owner }
						this = scope:owner
					}
				}
				agot_title_is_an_active_dragonpit = yes
			}
		}
		NOT = { has_character_flag = owned_dragon }
		NOT = { has_character_flag = in_dragonpit }
	}

	is_valid = {
		scope:owner = {
			custom_tooltip = {
				text = agot_capture_dragon_cd_gui_tt
				NOT = {
					has_variable = capture_cd
				}
			}
		}
	}

	ai_is_valid = {
		scope:owner ?= {
			agot_has_an_active_dragonpit = yes
		}
		has_trait = dragon
		exists = employer
		NOT = { has_character_flag = owned_dragon }
		NOT = { has_character_flag = in_dragonpit }
	}

	effect = {
		agot_change_dragonpit_status = yes
	}
}

send_to_dragonpit = {
	scope = character

	is_shown = {
		scope:owner ?= {
			agot_has_an_active_dragonpit = yes
		}
		has_trait = dragon
		exists = employer
		employer = scope:owner
		has_character_flag = owned_dragon
		NOT = { has_character_flag = in_dragonpit }
	}

	is_valid = {
		custom_tooltip = {
			text = CANT_SENT_TO_DRAGONPIT_TT
			NOT = {
				owns_story_of_type = story_dragon_at_war
			}
		}
		custom_tooltip = {
			text = CANT_SENT_TO_DRAGONPIT_TRAVELING_TT
			trigger_if = {
				limit = {
					exists = var:current_rider
					exists = var:current_rider.current_travel_plan
				}
				var:current_rider.current_travel_plan = {
					NOT = { has_travel_option = dragon_flight_option }
				}
			}
			NOT = { exists = current_travel_plan }
		}
	}

	ai_is_valid = {
		scope:owner ?= {
			agot_has_an_active_dragonpit = yes
		}
		has_trait = dragon
		exists = employer
		has_character_flag = owned_dragon
		NOT = { has_character_flag = in_dragonpit }
	}

	effect = {
		agot_change_dragonpit_status = yes
	}
}

remove_from_dragonpit = {
	scope = character

	is_shown = {
		has_trait = dragon
		exists = employer
		employer = scope:owner
		#has_character_flag = owned_dragon
		has_character_flag = in_dragonpit
	}

	ai_is_valid = {
		has_trait = dragon
		exists = employer
		#has_character_flag = owned_dragon
		has_character_flag = in_dragonpit
	}

	effect = {
		agot_change_dragonpit_status = yes
	}
}

agot_dragonpit_amenities_gui = {
	scope = character

	is_shown = {
		any_held_title = {
			tier = tier_county
			OR = {
				any_county_province = {
					has_holding_type = castle_holding
					has_building_or_higher = generic_dragon_pit_01
				}
				any_county_province = {
					OR = {
						has_building_or_higher = dragonpit_01 # Historical Version
						has_building = dragonpit_ruins_03 # Fully Restored Ruin Version
						has_building = agot_dragonmont_01 # Dragonmont
					}
				}
			}
			has_variable = has_dragonkeeper_order
		}
	}
}

agot_view_dragons_in_dragonpit = {
	scope = title

	is_shown = {
		OR = {
			has_building_or_higher = generic_dragon_pit_01
			has_building_or_higher = dragonpit_01 # Historical Version
			has_building = dragonpit_ruins_03 # Fully Restored Ruin Version
			has_building = agot_dragonmont_01 # Dragonmont
		}
	}

	effect = {
		trigger_event = agot_dragon_pits.0999
	}
}

agot_can_see_dragon_military_view = {
	scope = character
	is_shown = {
		OR = {
			any_courtier = {
				has_variable = current_rider # Tamed
			}
			any_courtier = {
				has_character_flag = owned_dragon # Owned
			}
			any_courtier = {
				has_trait = dragon # Wild
				NAND = {
					has_character_flag = owned_dragon
					has_character_flag = in_dragonpit
				}
			}
		}
	}
}

agot_can_see_owned_dragons_military = {
	scope = character
	is_shown = {
		any_courtier = {
			has_character_flag = owned_dragon
			NOT = {
				has_variable = current_rider
			}
		}
	}
}

agot_can_see_tamed_dragons_military = {
	scope = character
	is_shown = {
		any_courtier = {
			has_variable = current_rider
		}
	}
}

agot_can_see_wild_dragons_military = {
	scope = character
	is_shown = {
		any_courtier = {
			AND = {
				has_trait = dragon
				NOR = {
					has_character_flag = owned_dragon
					has_character_flag = in_dragonpit
					has_variable = current_rider
				}
			}
		}
	}
}

agot_visible_dragons_military_war_participant = {
	scope = character
	is_shown = {
		OR = {
			is_current_dragonrider = yes
			any_courtier = { is_current_dragonrider = yes }
			any_vassal = { is_current_dragonrider = yes }
		}
	}
}

agot_visible_dragons_military_war_overview = {
	scope = war
	saved_scopes = { participant }
	is_shown = {
		OR = {
			any_war_attacker = {
				this = scope:participant
				OR = {
					is_current_dragonrider = yes
					any_courtier = { is_current_dragonrider = yes }
					any_vassal = { is_current_dragonrider = yes }
				}
			}
			any_war_defender = {
				this = scope:participant
				OR = {
					is_current_dragonrider = yes
					any_courtier = { is_current_dragonrider = yes }
					any_vassal = { is_current_dragonrider = yes }
				}
			}
		}
	}
}

agot_dragons_military_war_overview_attacker = {
	scope = war
	saved_scopes = { attacker }
	is_shown = {
		any_war_attacker = {
			this = scope:attacker
			OR = {
				is_current_dragonrider = yes
				any_courtier = { is_current_dragonrider = yes }
				any_vassal = { is_current_dragonrider = yes }
			}
		}
	}
}

agot_dragons_military_war_overview_defender = {
	scope = war
	saved_scopes = { defender }
	is_shown = {
		any_war_defender = {
			this = scope:defender
			OR = {
				is_current_dragonrider = yes
				any_courtier = { is_current_dragonrider = yes }
				any_vassal = { is_current_dragonrider = yes }
			}
		}
	}
}

agot_dragons_versus_war_overview_attacker = {
	scope = war
	is_shown = {
		any_war_attacker = {
			OR = {
				is_current_dragonrider = yes
				any_courtier = { is_current_dragonrider = yes }
				any_vassal = { is_current_dragonrider = yes }
			}
		}
	}
}

agot_dragons_versus_war_overview_defender = {
	scope = war
	is_shown = {
		any_war_defender = {
			OR = {
				is_current_dragonrider = yes
				any_courtier = { is_current_dragonrider = yes }
				any_vassal = { is_current_dragonrider = yes }
			}
		}
	}
}

agot_male_gender_shown = {
	scope = character

	is_shown = {
		is_male = yes
		NOT = { has_trait = dragon }
	}
}

agot_female_gender_shown = {
	scope = character

	is_shown = {
		is_female = yes
		NOT = { has_trait = dragon }
	}
}

agot_unknown_gender_dragon_shown = {
	scope = character

	is_shown = {
		is_alive = yes
		has_trait = dragon
		has_variable = dragon_gender_hidden
	}
}

agot_male_gender_dragon_shown = {
	scope = character

	is_shown = {
		has_trait = dragon
		is_male = yes
		OR = {
			is_alive = no
			NOT = { has_variable = dragon_gender_hidden }
		}
	}
}

agot_female_gender_dragon_shown = {
	scope = character

	is_shown = {
		has_trait = dragon
		is_female = yes
		OR = {
			is_alive = no
			NOT = { has_variable = dragon_gender_hidden }
		}
	}
}

agot_show_dragon_past_rider_when_dead = {
	scope = character
	saved_scopes = {dragon}
	is_shown = {
		scope:dragon = {
			is_alive = no
		}
		title:c_ruins.holder = {
			any_owned_story = {
				story_type = story_dragon_variable_storage
				var:dragon_id ?= scope:dragon
				has_variable_list = past_riders
			}
		}
	}
	effect = {
		title:c_ruins.holder = {
			if = {
				limit = {
					agot_ruins_has_dragon_storage_system = yes
				}
			}
			random_owned_story = {
				limit = {
					var:dragon_id = scope:dragon
				}
				save_scope_as = story
			}
		}
		scope:story = {
			every_in_list = {
				variable = past_riders
				root = {
					add_to_variable_list = {
						name = possible_characters
						target = prev
					}
				}
			}
		}
		trigger_event = agot_dragon_maintenance.0803
	}
}

# For Dragon Event Windows
agot_dragon_event_check_if_night_flight = {
	scope = character
	is_shown = {
		has_character_flag = dragon_night_ride
		has_character_flag = currently_riding_dragon
	}
}

agot_dragon_event_check_if_day_flight = {
	scope = character
	is_shown = {
		NOT = { has_character_flag = dragon_night_ride }
		has_character_flag = currently_riding_dragon
	}
}

# For Character Window Portraits
agot_check_host = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		exists = root.liege_or_court_owner
		OR = {
			var:current_rider ?= { NOT = { this = root.liege_or_court_owner } }
			AND = {
				NOT = { has_variable = current_rider }
				any_relation = {
					type = agot_dragon
					is_alive = yes
				}
			}
			AND = {
				NOT = { has_variable = current_rider }
				NOT = {
					any_relation = {
						type = agot_dragon
						is_alive = yes
					}
				}
			}
		}
	}
}

agot_check_landed_rider = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		OR = {
			AND = {
				has_variable = current_rider
				NOT = { exists = root.liege_or_court_owner }
			}
			var:current_rider ?= { this = root.liege_or_court_owner }
		}
	}
}

agot_check_rider = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		exists = root.liege_or_court_owner
		OR = {
			var:current_rider ?= { this = { is_courtier_of = root.liege_or_court_owner } }
			var:current_rider ?= { NOT = { this = root.liege_or_court_owner } }
		}
	}
}

agot_check_bonded_human = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		any_relation = {
			type = agot_dragon
			is_alive = yes
		}
		NOT = { has_variable = current_rider }
	}
}

# For List COAs
agot_list_check_rider = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		has_character_flag = owned_dragon
		has_variable = current_rider
	}
}

agot_list_check_bonded_human = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		has_character_flag = owned_dragon
		any_relation = {
			type = agot_dragon
			is_alive = yes
		}
		NOT = { has_variable = current_rider }
	}
}

agot_list_check_host = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		AND = {
			NOT = { has_variable = current_rider }
			NOT = {
				any_relation = {
					type = agot_dragon
					is_alive = yes
				}
			}
		}
	}
}

agot_list_check_roaming = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		OR = {
			AND = {
				exists = root.liege_or_court_owner
				exists = root.location.county
				NOT = { root.liege_or_court_owner = root.location.county.holder }
			}
			NOT = { exists = root.liege_or_court_owner }
		}
		NOT = { has_character_flag = owned_dragon }
		NOT = { has_variable = current_rider }
		NOT = {
			any_relation = {
				type = agot_dragon
				is_alive = yes
			}
		}
		NOT = { has_variable = pitted_dragon_location }
	}
}

# For commander list Dragonrider icon
agot_commander_list_check_rider = {
	scope = character
	is_shown = {
		is_alive = yes
		has_variable = current_dragon
		is_current_dragonrider_warfare = yes
	}
}

# For Relation and Location Information
agot_relation_check_rider = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		has_character_flag = owned_dragon
		has_variable = current_rider
		NOT = { has_character_flag = in_dragonpit }
		NOT = { has_variable = pitted_dragon_location }
	}
}

agot_relation_check_bonded_human = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		has_character_flag = owned_dragon
		any_relation = {
			type = agot_dragon
			is_alive = yes
			NOT = { this = root.liege_or_court_owner }
		}
		NOT = { has_variable = current_rider }
		NOT = { has_character_flag = in_dragonpit }
		NOT = { has_variable = pitted_dragon_location }
	}
}

agot_relation_check_host = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		has_character_flag = in_dragonpit
		has_variable = pitted_dragon_location
	}
}

agot_relation_check_free = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		has_character_flag = owned_dragon
		NOT = { has_variable = current_rider }
		NOT = {
			any_relation = {
				type = agot_dragon
				is_alive = yes
			}
		}
		NOT = { has_variable = pitted_dragon_location }
	}
}

agot_relation_check_wild = {
	scope = character
	is_shown = {
		is_alive = yes
		has_trait = dragon
		NOT = { has_character_flag = owned_dragon }
		NOT = { has_variable = current_rider }
		NOT = {
			any_relation = {
				type = agot_dragon
				is_alive = yes
			}
		}
		NOT = { has_variable = pitted_dragon_location }
	}
}